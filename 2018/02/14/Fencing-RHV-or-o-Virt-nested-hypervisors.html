<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Fencing RHV or oVirt nested hypervisors</title>
    <meta name="description" content="" />
    <link href="//fonts.googleapis.com/css?family=Noto+Sans:300,400,700" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic" rel="stylesheet" type="text/css">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link href="//100things.wzzrd.com/themes/saga/assets/css/style.css?v=1530100205746" rel="stylesheet" type="text/css">
    <link href="//100things.wzzrd.com/themes/saga/assets/css/animate.min.css?v=1530100205746" rel="stylesheet" type="text/css">
    <link href="http://100things.wzzrd.com/favicon.ico" rel="shortcut icon">
    <link rel="canonical" href="http://100things.wzzrd.com/2018/02/14/Fencing-RHV-or-o-Virt-nested-hypervisors.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="100 things to do with Red Hat Management Products" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Fencing RHV or oVirt nested hypervisors" />
    <meta property="og:description" content="My setup I have this nice AMD Ryzen ThreadRipper, with 64GiB or RAM. What I want to do is run RHV 4.1 in virtual machines, and be able to play around with nested virtualization, HA and fencing. Problem is, that my virtual machines will live on libvirt, and VMs" />
    <meta property="og:url" content="http://100things.wzzrd.com/2018/02/14/Fencing-RHV-or-o-Virt-nested-hypervisors.html" />
    <meta property="article:published_time" content="2018-02-14T00:00:00.000Z" />
    <meta property="article:tag" content="RHV" />
    <meta property="article:tag" content="oVirt" />
    <meta property="article:tag" content="fencing" />
    <meta property="article:tag" content="virtualbmc" />
    <meta property="article:tag" content="libvirt" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Fencing RHV or oVirt nested hypervisors" />
    <meta name="twitter:description" content="My setup I have this nice AMD Ryzen ThreadRipper, with 64GiB or RAM. What I want to do is run RHV 4.1 in virtual machines, and be able to play around with nested virtualization, HA and fencing. Problem is, that my virtual machines will live on libvirt, and VMs" />
    <meta name="twitter:url" content="http://100things.wzzrd.com/2018/02/14/Fencing-RHV-or-o-Virt-nested-hypervisors.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "100 things to do with Red Hat Management Products",
    "author": {
        "@type": "Person",
        "name": "Maxim Burgerhout",
        "image": "https://avatars1.githubusercontent.com/u/69339?v=4",
        "url": "http://100things.wzzrd.com/author/wzzrd/",
        "sameAs": "https://about.me/MaximBurgerhout",
        "description": "Solution architect at Red Hat for the platform and cloud portfolio; likes Python, likes Ruby, internally conflicted about that; maintainer of @RedHatSatellite"
    },
    "headline": "Fencing RHV or oVirt nested hypervisors",
    "url": "http://100things.wzzrd.com/2018/02/14/Fencing-RHV-or-o-Virt-nested-hypervisors.html",
    "datePublished": "2018-02-14T00:00:00.000Z",
    "keywords": "RHV, oVirt, fencing, virtualbmc, libvirt",
    "description": "My setup I have this nice AMD Ryzen ThreadRipper, with 64GiB or RAM. What I want to do is run RHV 4.1 in virtual machines, and be able to play around with nested virtualization, HA and fencing. Problem is, that my virtual machines will live on libvirt, and VMs"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="100 things to do with Red Hat Management Products" href="http://100things.wzzrd.com/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/themes/prism-okaidia.min.css">
    
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
</head>
<body class="post-template tag-RHV tag-o-Virt tag-fencing tag-virtualbmc tag-libvirt">
    <header id="header" class="animated fadeIn">
    <div class="header-background">
    <section class="blog-content">
        <a id="site-url" class="blog-title" href="http://100things.wzzrd.com">100 things to do with Red Hat Management Products</a>
        <span class="blog-description">A series of blogs and videos about the cool things you can do with Red Hat (Systems) Management products </span>
        <nav class="links fadeIn animated">
            <ul>
                <li class="rss"><a title="RSS Feed" href="/rss/"><i class="fa fa-fw fa-rss-square"></i></a></li>
        
            </ul>
        </nav>
    </section>
    <section class="header-content">
        <h1 class="post-title animated fadeInUp">Fencing RHV or oVirt nested hypervisors</h1>
        <span class="post-data"><span class="date animated fadeInUp"><i class="fa fa-clock-o"></i> <time class="timesince date" data-timesince="1518562800" datetime="2018-02-14T00:00" title="14 February 2018">4 months ago</time></span>
            <span class="tags animated fadeInUp"><i class="fa fa-tags"></i> <a href="http://100things.wzzrd.com/tag/RHV/">RHV</a>, <a href="http://100things.wzzrd.com/tag/o-Virt/">oVirt</a>, <a href="http://100things.wzzrd.com/tag/fencing/">fencing</a>, <a href="http://100things.wzzrd.com/tag/virtualbmc/">virtualbmc</a>, <a href="http://100things.wzzrd.com/tag/libvirt/">libvirt</a></span>
            <span class="author animated fadeInUp"><i class="fa fa-user"></i> <a href="http://100things.wzzrd.com/author/wzzrd/">Maxim Burgerhout</a></span></span>
    </section>
    </div>
</header>
<main id="main" class="content">
    <article itemtype="http://schema.org/BlogPosting" class="animated fadeIn content post post tag-RHV tag-o-Virt tag-fencing tag-virtualbmc tag-libvirt">
        <section class="post-content">
            <div class="sect1">
<h2 id="_my_setup">My setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I have this nice AMD Ryzen ThreadRipper, with 64GiB or RAM. What I want to do is run RHV 4.1 in virtual machines, and be able to play around with nested virtualization, HA and fencing.</p>
</div>
<div class="paragraph">
<p>Problem is, that my virtual machines will live on libvirt, and VMs on libvirt do not have IPMI interfaces.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_solution">The solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Enter virtualbmc! Stemming from the OpenStack project, virtualbmc is a small Python program that allows you to connect a virtual BMC interface to some of your VMs.</p>
</div>
<div class="paragraph">
<p>The way it works, is as follows:</p>
</div>
<div class="paragraph">
<p>You enable my copr, like njah:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ sudo dnf copr enable wzzrd/virtualbmc</code></pre>
</div>
</div>
<div class="paragraph">
<p>and then you install the actual program, like njah:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sudo dnf install python2-virtualbmc python-virtualbmc-doc</code></pre>
</div>
</div>
<div class="paragraph">
<p>Virtualbmc will create a virtual BMC device for each VM you configure it for. If you, like me, want to have all BMC interfaces on the gateway of your virtual network, you need to choose a unique port for each virtual BMC interface. More below.</p>
</div>
<div class="sect2">
<h3 id="_configuring_virtualbmc">Configuring virtualbmc</h3>
<div class="paragraph">
<p>Now you have to add virtual BMC interfaces to the VMs you want to control. For this, you need to pass the name of your VM, an address to bind to (optionally), a port to listen on, and a username and password to control the BMC.</p>
</div>
<div class="paragraph">
<p>As said, I want all virtual BMCs to live on my virtual network gateway, 192.168.122.1, so I create the virtual BMC devices like njah:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ sudo vbmc add rhv-node-01.deployment6.lan --address 192.168.122.1 --port 7001 --username root --password foobar
$ sudo vbmc add rhv-node-02.deployment6.lan --address 192.168.122.1 --port 7001 --username root --password foobar</code></pre>
</div>
</div>
<div class="paragraph">
<p>My hypervisor VMs (the so-called L1 machines), are obviously called rhv-node-01.deployment6.lan and rhv-node-02.deployment6.lan.</p>
</div>
</div>
<div class="sect2">
<h3 id="_starting_the_virtual_bmcs">Starting the virtual BMCs</h3>
<div class="paragraph">
<p>After creating the interfaces, we can see them, like njah:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ sudo vbmc list
+-----------------------------+--------+---------------+------+
|         Domain name         | Status |    Address    | Port |
+-----------------------------+--------+---------------+------+
| rhv-node-01.deployment6.lan |  down  | 192.168.122.1 | 7001 |
| rhv-node-02.deployment6.lan |  down  | 192.168.122.1 | 7002 |
+-----------------------------+--------+---------------+------+</code></pre>
</div>
</div>
<div class="paragraph">
<p>And we can then start them to be used in RHV:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sudo vbmc start rhv-node-01.deployment6.lan
sudo vbmc start rhv-node-02.deployment6.lan</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which gives us njah:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ sudo vbmc list
+-----------------------------+--------+------------------+------+
|         Domain name         |   Status  |    Address    | Port |
+-----------------------------+-----------+---------------+------+
| rhv-node-01.deployment6.lan |  running  | 192.168.122.1 | 7001 |
| rhv-node-02.deployment6.lan |  running  | 192.168.122.1 | 7002 |
+-----------------------------+--------+------------------+------+</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_power_management_for_the_rhv_nodes">Configuring power management for the RHV nodes</h3>
<div class="paragraph">
<p>Now, start your VMs, and in RHVM, go into the power management interface for each hypervisor, and do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add a power management interface of type IPMILAN.</p>
</li>
<li>
<p>As the IP, pass the 192.168.122.1 the we used above (or your equivalent)</p>
</li>
<li>
<p>As the username and password, pass the values we used above</p>
</li>
<li>
<p>Now here comes the tricky bit: in the options field, for each hypervisor, add:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>ipport=7001,lanplus=1</pre>
</div>
</div>
<div class="paragraph">
<p>Change the port to reflect the port you have configured for this VM.</p>
</div>
<div class="paragraph">
<p>It took me quite a bit of time to figure out the right options here. Hope this saves someone else a bunch of time!</p>
</div>
<div class="paragraph">
<p>Happy testing!</p>
</div>
</div>
</div>
</div>
        </section>

    
        <section class="post-comments">
          <div id="disqus_thread"></div>
          <script type="text/javascript">
          var disqus_shortname = '100things'; // required: replace example with your forum shortname
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </section>
    
    </article>

</main>
    <footer class="animated fadeIn" id="footer">
        <section class="colophon">
          <section class="copyright">Copyright &copy; <span itemprop="copyrightHolder">100 things to do with Red Hat Management Products</span>. <span rel="license">All Rights Reserved</span>.</section>
          <section class="poweredby">Published with <a class="icon-ghost" href="https://hubpress.github.io">HubPress</a></section>
        </section>
        <section class="bottom">
          <section class="attribution">
            <a href="http://github.com/Reedyn/Saga">Built with <i class="fa fa-heart"></i> and Free and Open-Source Software</a>.
          </section>
        </section>
    </footer>

    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/prism/1.14.0/prism.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        // hljs.initHighlightingOnLoad();
      </script>
    <script src="//100things.wzzrd.com/themes/saga/assets/js/scripts.js?v=1530100205746"></script>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-1886096-11', 'auto');
    ga('send', 'pageview');

    </script>
</body>
</html>
